import{r as d,j as s,am as O,an as ee}from"./vendor-react-BgpSLK3q.js";import{I as R}from"./input-mWpG_fYx.js";import{i as x,b,s as c,c as se,u as te,C as P,l as U,m as B,a as z,B as I}from"./index-wTsEScI4.js";import{j as re,k as ae}from"./follows-eIrmx8CI.js";import{a5 as oe,a6 as ne,a7 as ie,a8 as W}from"./vendor-radix-B3dsqebR.js";import{T as ce,a as de,b as J,c as V}from"./tabs-BupnlxSv.js";import"./vendor-MRMtI2Il.js";import"./vendor-supabase-DQanAYxp.js";import"./vendor-router-VbqrkW3a.js";import"./vendor-style--X5BZniO.js";import"./vendor-query-DDnmq2va.js";async function le(o){if(x())return await b("/dms/conversations",{method:"POST",body:JSON.stringify({otherId:o})});const{data:h,error:l}=await c.rpc("create_or_get_conversation",{other_user_id:o});if(l)throw l;return{id:String(h),user_a:"",user_b:"",created_at:new Date().toISOString()}}async function me(o){if(x())return await b(`/dms/conversations/${o}/messages`);const{data:h,error:l}=await c.from("messages").select("*").eq("conversation_id",o).order("created_at",{ascending:!0});if(l)throw l;return h||[]}async function A(o,h){if(x())return await b(`/dms/conversations/${o}/messages`,{method:"POST",body:JSON.stringify({content:h})});const{data:l,error:g}=await c.from("messages").insert({conversation_id:o,content:h}).select().single();if(g)throw g;return l}const ue=oe,he=ne,K=d.forwardRef(({className:o,align:h="center",sideOffset:l=4,...g},v)=>s.jsx(ie,{children:s.jsx(W,{ref:v,align:h,sideOffset:l,className:se("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",o),...g})}));K.displayName=W.displayName;const fe=["ðŸ˜Š","ðŸ˜‚","â¤ï¸","ðŸ‘","ðŸ™","ðŸŽ‰","ðŸ”¥","â­","ðŸ‘","ðŸ™Œ","ðŸ’ª","âœ¨","ðŸŒŸ","ðŸ•ï¸","â›º","ðŸŽ’","ðŸ”¦","ðŸ§­","ðŸªµ","ðŸ”¥"],pe=["ðŸ•ï¸ Campamento","â›º Carpa","ðŸŽ’ Mochila","ðŸ”¦ Linterna","ðŸ§­ BrÃºjula","ðŸªµ Fogata","ðŸŒ² Bosque","âšœï¸ Flor de Lis","ðŸª¢ Nudo","ðŸŽ¯ Siempre Listo","ðŸ¦… Ãguila","ðŸº Lobo","âš¡ RelÃ¡mpago","ðŸŒ™ Luna","â˜€ï¸ Sol"];function Ee(){const[o,h]=d.useState([]),[l,g]=d.useState(new Set),[v,G]=d.useState(""),[_,H]=d.useState(null),[m,k]=d.useState(null),[F,N]=d.useState([]),[C,S]=d.useState(""),[E,L]=d.useState(""),y=d.useRef(null),{toast:j}=te();d.useEffect(()=>{(async()=>{if(x()){const r=await b("/profiles/me"),n=String(r.id||r.user_id);L(n);const{data:i}=await re(n),{data:f}=await ae(n),w=new Set((i||[]).map(u=>String(u.followed_id||u.following_id))),p=new Set((f||[]).map(u=>String(u.follower_id))),M=new Set;w.forEach(u=>{p.has(u)&&M.add(u)}),g(M);const $=Array.from(M),Z=$.length?await b("/profiles/batch",{method:"POST",body:JSON.stringify({ids:$})}):[];h(Z.map(u=>({user_id:String(u.user_id),nombre_completo:u.nombre_completo??null,username:u.username??null,avatar_url:u.avatar_url??null})));return}const{data:e}=await c.auth.getUser();if(e.user){L(e.user.id);const{data:r}=await c.from("follows").select("followed_id").eq("follower_id",e.user.id).eq("status","accepted"),{data:n}=await c.from("follows").select("follower_id").eq("followed_id",e.user.id).eq("status","accepted"),i=new Set((r||[]).map(p=>p.followed_id)),f=new Set((n||[]).map(p=>p.follower_id)),w=new Set;i.forEach(p=>{f.has(p)&&w.add(p)}),g(w)}const{data:t,error:a}=await c.rpc("list_profiles_directory");a?console.error(a):h(t.map(r=>({user_id:String(r.user_id),nombre_completo:r.nombre_completo??null,username:r.username??null,avatar_url:r.avatar_url??null})))})()},[]);const q=d.useMemo(()=>{const e=v.trim().toLowerCase(),t=o.filter(a=>a.user_id!==E&&l.has(a.user_id));return e?t.filter(a=>{const r=(a.username||"").toLowerCase().includes(e),n=(a.nombre_completo||"").toLowerCase().includes(e),i=e.startsWith("@")&&(a.username||"").toLowerCase().includes(e.slice(1));return r||n||i}).slice(0,10):t.slice(0,10)},[v,o,E,l]),Q=async()=>{if(_)try{if(x()){const e=await le(_.user_id);k(e.id),T(e.id)}else{const{data:e,error:t}=await c.rpc("create_or_get_conversation",{other_user_id:_.user_id});if(t)throw t;k(String(e)),T(String(e))}}catch(e){j({title:"Error",description:e.message,variant:"destructive"})}},T=async e=>{if(x()){try{const i=(await me(e)).map(f=>{const w=o.find(p=>p.user_id===f.sender_id);return{...f,sender_username:w?.username,sender_name:w?.nombre_completo}});N(i),setTimeout(()=>{y.current?.scrollIntoView({behavior:"smooth"})},100)}catch(n){j({title:"Error",description:n.message,variant:"destructive"})}return}const{data:t,error:a}=await c.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(a){j({title:"Error",description:a.message,variant:"destructive"});return}const r=t.map(n=>{const i=o.find(f=>f.user_id===n.sender_id);return{...n,sender_username:i?.username,sender_name:i?.nombre_completo}});N(r),setTimeout(()=>{y.current?.scrollIntoView({behavior:"smooth"})},100)};d.useEffect(()=>{if(!m)return;if(x()){const t=setInterval(()=>{T(m)},1500);return()=>clearInterval(t)}const e=c.channel(`messages:${m}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`conversation_id=eq.${m}`},t=>{const a=t.new,r=o.find(i=>i.user_id===a.sender_id),n={...a,sender_username:r?.username,sender_name:r?.nombre_completo};N(i=>i.some(f=>f.id===n.id)?i:[...i,n]),setTimeout(()=>{y.current?.scrollIntoView({behavior:"smooth"})},100)}).subscribe();return()=>{c.removeChannel(e)}},[m,o]);const D=async()=>{if(!m||!C.trim())return;const e=C.trim();S("");try{if(x())await A(m,e);else{const{data:t}=await c.auth.getUser(),a=t.user?.id,{error:r}=await c.from("messages").insert({conversation_id:m,sender_id:a,content:e});if(r)throw r}}catch(t){S(e),j({title:"Error",description:t.message,variant:"destructive"})}},X=e=>{S(t=>t+e)},Y=async e=>{if(m)try{if(x())await A(m,e);else{const{data:t}=await c.auth.getUser(),a=t.user?.id,{error:r}=await c.from("messages").insert({conversation_id:m,sender_id:a,content:e});if(r)throw r}}catch(t){j({title:"Error",description:t.message,variant:"destructive"})}};return s.jsxs("div",{className:"min-h-screen bg-background",children:[s.jsx("div",{className:"h-16 sm:h-20"}),s.jsxs("div",{className:"max-w-5xl mx-auto px-4 py-6 sm:py-8 grid grid-cols-1 md:grid-cols-3 gap-6",children:[s.jsxs(P,{className:"md:col-span-1",children:[s.jsxs(U,{children:[s.jsx(B,{children:"Inicia una conversaciÃ³n"}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Solo con personas que se siguen mutuamente"})]}),s.jsxs(z,{children:[s.jsx(R,{placeholder:"Buscar por nombre o @usuario",value:v,onChange:e=>G(e.target.value)}),s.jsx("div",{className:"mt-3 space-y-2 max-h-64 overflow-auto",children:q.length===0?s.jsx("div",{className:"text-sm text-muted-foreground text-center py-4",children:"No hay contactos mutuos disponibles"}):q.map(e=>s.jsxs("button",{className:`w-full text-left p-2 rounded border transition-colors ${_?.user_id===e.user_id?"bg-primary/10 border-primary/50":"hover:bg-muted/50 border-border"}`,onClick:()=>H(e),children:[s.jsx("div",{className:"font-medium",children:e.nombre_completo||"Scout"}),s.jsx("div",{className:"text-xs text-muted-foreground",children:e.username?`@${e.username}`:""})]},e.user_id))}),s.jsx(I,{className:"w-full mt-3",disabled:!_,onClick:Q,children:"Abrir chat"})]})]}),s.jsxs(P,{className:"md:col-span-2",children:[s.jsx(U,{children:s.jsx(B,{children:"Chat"})}),s.jsx(z,{children:m?s.jsxs("div",{className:"flex flex-col h-[60vh]",children:[s.jsx("div",{className:"flex-1 overflow-auto space-y-3 p-4 border rounded mb-2",children:F.length===0?s.jsx("div",{className:"text-muted-foreground text-sm text-center py-8",children:"Sin mensajes aÃºn"}):s.jsxs(s.Fragment,{children:[F.map(e=>{const t=e.sender_id===E;return s.jsx("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`max-w-[75%] rounded-lg px-3 py-2 ${t?"bg-primary text-primary-foreground":"bg-muted"}`,children:[!t&&s.jsx("div",{className:"text-xs opacity-70 mb-1",children:e.sender_username?`@${e.sender_username}`:e.sender_name||"Scout"}),s.jsx("div",{className:"text-sm",children:e.content}),s.jsx("div",{className:`text-xs mt-1 ${t?"opacity-70":"opacity-50"}`,children:new Date(e.created_at).toLocaleTimeString("es-ES",{hour:"2-digit",minute:"2-digit"})})]})},e.id)}),s.jsx("div",{ref:y})]})}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx(R,{placeholder:"Escribe un mensaje...",value:C,onChange:e=>S(e.target.value),onKeyDown:e=>{e.key==="Enter"&&(e.preventDefault(),D())}}),s.jsxs(ue,{children:[s.jsx(he,{asChild:!0,children:s.jsx(I,{variant:"outline",size:"icon",children:s.jsx(O,{className:"h-4 w-4"})})}),s.jsx(K,{className:"w-80",children:s.jsxs(ce,{defaultValue:"emojis",children:[s.jsxs(de,{className:"grid w-full grid-cols-2",children:[s.jsxs(J,{value:"emojis",children:[s.jsx(O,{className:"h-4 w-4 mr-2"}),"Emojis"]}),s.jsxs(J,{value:"stickers",children:[s.jsx(ee,{className:"h-4 w-4 mr-2"}),"Stickers"]})]}),s.jsx(V,{value:"emojis",className:"mt-2",children:s.jsx("div",{className:"grid grid-cols-10 gap-1",children:fe.map((e,t)=>s.jsx("button",{onClick:()=>X(e),className:"text-2xl hover:bg-muted rounded p-1 transition-colors",children:e},t))})}),s.jsx(V,{value:"stickers",className:"mt-2",children:s.jsx("div",{className:"grid grid-cols-1 gap-1 max-h-64 overflow-auto",children:pe.map((e,t)=>s.jsx("button",{onClick:()=>Y(e),className:"text-left px-3 py-2 hover:bg-muted rounded transition-colors text-sm",children:e},t))})})]})})]}),s.jsx(I,{onClick:D,children:"Enviar"})]})]}):s.jsx("div",{className:"text-muted-foreground",children:"Selecciona un usuario y abre el chat."})})]})]})]})}export{Ee as default};
